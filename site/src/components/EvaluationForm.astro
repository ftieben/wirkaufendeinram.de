---
/**
 * Evaluation Form Component
 * Collects RAM specifications and seller contact information with real-time validation
 */
---

<div class="evaluation-form-container">
  <div class="form-header">
    <h2>Erhalten Sie sofort Ihr RAM-Angebot</h2>
    <p>Geben Sie unten Ihre RAM-Spezifikationen ein, um eine sofortige Preissch√§tzung zu erhalten</p>
    <div class="parody-hint">
      <span class="hint-icon">üöó‚û°Ô∏èüíæ</span>
      <span class="hint-text">Genau wie ein Auto verkaufen, aber viel nerdiger!</span>
    </div>
  </div>

  <form id="ram-evaluation-form" class="evaluation-form">
    <!-- RAM Specifications Section -->
    <fieldset class="form-section">
      <legend>RAM-Spezifikationen</legend>
      
      <div class="form-group">
        <label for="ram-type">RAM-Typ *</label>
        <select id="ram-type" name="type" required>
          <option value="">RAM-Typ ausw√§hlen</option>
          <option value="DDR3">DDR3</option>
          <option value="DDR4">DDR4</option>
          <option value="DDR5">DDR5</option>
        </select>
        <div class="error-message" id="type-error"></div>
      </div>

      <div class="form-group">
        <label for="capacity">Kapazit√§t (GB) *</label>
        <select id="capacity" name="capacity" required>
          <option value="">Kapazit√§t ausw√§hlen</option>
          <option value="1">1 GB</option>
          <option value="2">2 GB</option>
          <option value="4">4 GB</option>
          <option value="8">8 GB</option>
          <option value="16">16 GB</option>
          <option value="32">32 GB</option>
          <option value="64">64 GB</option>
          <option value="128">128 GB</option>
        </select>
        <div class="error-message" id="capacity-error"></div>
      </div>

      <div class="form-group">
        <label for="speed">Geschwindigkeit (MHz) *</label>
        <input 
          type="number" 
          id="speed" 
          name="speed" 
          placeholder="z.B. 3200" 
          min="800" 
          max="6400" 
          required
        />
        <div class="error-message" id="speed-error"></div>
        <div class="help-text">√úbliche Geschwindigkeiten: DDR3 (800-2133), DDR4 (1600-3200), DDR5 (3200-6400)</div>
      </div>

      <div class="form-group">
        <label for="brand">Marke *</label>
        <select id="brand" name="brand" required>
          <option value="">Marke ausw√§hlen</option>
          <option value="Corsair">Corsair</option>
          <option value="G.Skill">G.Skill</option>
          <option value="Kingston">Kingston</option>
          <option value="Crucial">Crucial</option>
          <option value="Samsung">Samsung</option>
          <option value="SK Hynix">SK Hynix</option>
          <option value="Micron">Micron</option>
          <option value="ADATA">ADATA</option>
          <option value="Team">Team</option>
          <option value="Patriot">Patriot</option>
          <option value="HyperX">HyperX</option>
          <option value="Mushkin">Mushkin</option>
          <option value="GeIL">GeIL</option>
        </select>
        <div class="error-message" id="brand-error"></div>
      </div>

      <div class="form-group">
        <label for="condition">Zustand *</label>
        <select id="condition" name="condition" required>
          <option value="">Zustand ausw√§hlen</option>
          <option value="new">Neu (unge√∂ffnet, mit Garantie)</option>
          <option value="excellent">Ausgezeichnet (wie neu, minimale Nutzung)</option>
          <option value="good">Gut (normale Abnutzung, voll funktionsf√§hig)</option>
          <option value="fair">Akzeptabel (sichtbare Abnutzung, aber funktioniert)</option>
        </select>
        <div class="error-message" id="condition-error"></div>
      </div>

      <div class="form-group">
        <label for="quantity">Anzahl *</label>
        <input 
          type="number" 
          id="quantity" 
          name="quantity" 
          placeholder="Anzahl der Module" 
          min="1" 
          max="100" 
          required
        />
        <div class="error-message" id="quantity-error"></div>
      </div>
    </fieldset>

    <!-- Contact Information Section -->
    <fieldset class="form-section">
      <legend>Kontaktinformationen</legend>
      
      <div class="form-group">
        <label for="name">Vollst√§ndiger Name *</label>
        <input 
          type="text" 
          id="name" 
          name="name" 
          placeholder="Ihr vollst√§ndiger Name" 
          required
        />
        <div class="error-message" id="name-error"></div>
      </div>

      <div class="form-group">
        <label for="email">E-Mail-Adresse *</label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          placeholder="ihre.email@beispiel.de" 
          required
        />
        <div class="error-message" id="email-error"></div>
      </div>

      <div class="form-group">
        <label for="phone">Telefonnummer *</label>
        <input 
          type="tel" 
          id="phone" 
          name="phone" 
          placeholder="0123 456789" 
          required
        />
        <div class="error-message" id="phone-error"></div>
      </div>

      <div class="form-group">
        <label for="preferred-contact">Bevorzugte Kontaktmethode *</label>
        <select id="preferred-contact" name="preferredContact" required>
          <option value="">Pr√§ferenz ausw√§hlen</option>
          <option value="email">E-Mail</option>
          <option value="phone">Telefon</option>
          <option value="either">E-Mail oder Telefon</option>
        </select>
        <div class="error-message" id="preferredContact-error"></div>
      </div>

      <div class="form-group">
        <label for="location">Standort (Stadt, Bundesland) *</label>
        <input 
          type="text" 
          id="location" 
          name="location" 
          placeholder="z.B. M√ºnchen, Bayern" 
          required
        />
        <div class="error-message" id="location-error"></div>
        <div class="help-text">Wird f√ºr Versandkostensch√§tzungen verwendet</div>
      </div>
    </fieldset>

    <!-- Form Actions -->
    <div class="form-actions">
      <button type="button" id="clear-form" class="btn-secondary">Formular l√∂schen</button>
      <button type="submit" id="submit-form" class="btn-primary">Mein Angebot erhalten</button>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="loading-state" style="display: none;">
      <div class="spinner"></div>
      <p>Ihr Angebot wird berechnet...</p>
    </div>
  </form>

  <!-- Quote Results Section -->
  <div id="quote-results" class="quote-results" style="display: none;">
    <div class="quote-header">
      <h3>Ihr RAM-Angebot</h3>
    </div>
    <div class="quote-content">
      <div class="estimated-value">
        <span class="label">Gesch√§tzter Wert:</span>
        <span class="value" id="quote-value">0,00 ‚Ç¨</span>
      </div>
      <div class="price-range">
        <span class="label">Preisspanne:</span>
        <span class="range" id="quote-range">0,00 ‚Ç¨ - 0,00 ‚Ç¨</span>
      </div>
      <div class="timeline">
        <span class="label">Antwortzeit:</span>
        <span class="time" id="quote-timeline">-</span>
      </div>
      <div class="factors">
        <h4>Preisfaktoren:</h4>
        <ul id="quote-factors"></ul>
      </div>
      <div class="next-steps">
        <h4>N√§chste Schritte:</h4>
        <ol id="quote-next-steps"></ol>
      </div>
    </div>
    <div class="quote-actions">
      <button type="button" id="new-quote" class="btn-secondary">Weiteres Angebot erhalten</button>
      <button type="button" id="accept-quote" class="btn-primary">Dieses Angebot annehmen</button>
    </div>
  </div>
</div>

<style>
  .evaluation-form-container {
    max-width: 850px;
    margin: 0 auto;
    padding: 3rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
    border: 1px solid #e2e8f0;
  }

  .form-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .form-header h2 {
    color: #1e293b;
    font-size: 2.25rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    margin-bottom: 0.5rem;
  }

  .form-header p {
    color: #64748b;
    font-size: 1.125rem;
    margin-bottom: 1rem;
    font-weight: 400;
  }

  .parody-hint {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    border: 1px solid #d97706;
    border-radius: 50px;
    padding: 0.75rem 1.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
  }

  .hint-icon {
    font-size: 1rem;
  }

  .hint-text {
    color: #78350f;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .evaluation-form {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 2rem;
  }

  .form-section {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    background: #fafbfc;
  }

  .form-section legend {
    font-weight: 700;
    color: #1e293b;
    padding: 0 0.75rem;
    font-size: 1.25rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.5rem;
    font-size: 0.9375rem;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: #f8fafc;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    background: white;
  }

  .form-group input.error,
  .form-group select.error {
    border-color: #e53e3e;
  }

  .error-message {
    color: #e53e3e;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    min-height: 1.25rem;
  }

  .help-text {
    color: #718096;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 1rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    font-size: 1.0625rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
  }

  .btn-primary:disabled {
    background: #cbd5e0;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-secondary {
    background-color: white;
    color: #475569;
    border: 2px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .btn-secondary:hover {
    background-color: #f8fafc;
    border-color: #cbd5e0;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  }

  .loading-state {
    text-align: center;
    padding: 2rem;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top: 4px solid #3182ce;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .quote-results {
    background: #f7fafc;
    border-radius: 8px;
    padding: 2rem;
    margin-top: 2rem;
    border: 1px solid #e2e8f0;
  }

  .quote-header h3 {
    color: #1a365d;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .estimated-value {
    text-align: center;
    margin-bottom: 1rem;
  }

  .estimated-value .value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #38a169;
    display: block;
    transition: transform 0.3s ease;
  }

  .price-range,
  .timeline {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e2e8f0;
  }

  .factors,
  .next-steps {
    margin: 1.5rem 0;
  }

  .factors h4,
  .next-steps h4 {
    color: #2d3748;
    margin-bottom: 0.5rem;
  }

  .factors ul,
  .next-steps ol {
    margin: 0;
    padding-left: 1.5rem;
  }

  .factors li,
  .next-steps li {
    margin-bottom: 0.25rem;
    color: #4a5568;
  }

  .quote-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
  }

  @media (max-width: 768px) {
    .evaluation-form-container {
      padding: 2rem 1.5rem;
      border-radius: 16px;
    }

    .form-header h2 {
      font-size: 1.875rem;
    }

    .form-section {
      padding: 1.5rem;
    }

    .form-actions,
    .quote-actions {
      flex-direction: column;
    }

    .btn-primary,
    .btn-secondary {
      width: 100%;
    }
  }
</style>

<script>
  import { validateRAMSpecification, validateSellerContact } from '../lib/validation.js';
  import { generateQuote } from '../lib/pricing.js';
  import { submitQuoteRequest } from '../lib/submission.js';
  import type { RAMSpecification, SellerContact, QuoteResponse, ValidationError } from '../lib/types.js';

  // Form elements with proper null safety
  const form = document.getElementById('ram-evaluation-form') as HTMLFormElement | null;
  const loadingState = document.getElementById('loading-state') as HTMLElement | null;
  const quoteResults = document.getElementById('quote-results') as HTMLElement | null;
  const clearButton = document.getElementById('clear-form') as HTMLButtonElement | null;
  const newQuoteButton = document.getElementById('new-quote') as HTMLButtonElement | null;
  const acceptQuoteButton = document.getElementById('accept-quote') as HTMLButtonElement | null;

  // Form state with proper typing
  let currentQuote: QuoteResponse | null = null;

  // Real-time validation setup
  function setupRealTimeValidation(): void {
    if (!form) return;
    
    const fields = form.querySelectorAll('input, select') as NodeListOf<HTMLInputElement | HTMLSelectElement>;
    
    fields.forEach(field => {
      field.addEventListener('blur', () => validateField(field));
      field.addEventListener('input', () => clearFieldError(field));
    });
  }

  // Validate individual field
  function validateField(field: HTMLInputElement | HTMLSelectElement): void {
    const fieldName = field.name;
    
    // Clear previous error
    clearFieldError(field);
    
    // Get current form data for context-aware validation
    const formData = getFormData();
    if (!formData) return;
    
    // Validate based on field type
    if (['type', 'capacity', 'speed', 'brand', 'condition', 'quantity'].includes(fieldName)) {
      const ramValidation = validateRAMSpecification(formData.ramSpec);
      const fieldError = ramValidation.errors.find((error: ValidationError) => error.field === fieldName);
      if (fieldError) {
        showFieldError(field, fieldError.message);
      }
    } else if (['name', 'email', 'phone', 'preferredContact', 'location'].includes(fieldName)) {
      const contactValidation = validateSellerContact(formData.contact);
      const fieldError = contactValidation.errors.find((error: ValidationError) => error.field === fieldName);
      if (fieldError) {
        showFieldError(field, fieldError.message);
      }
    }
  }

  // Show field error
  function showFieldError(field: HTMLInputElement | HTMLSelectElement, message: string): void {
    field.classList.add('error');
    const errorElement = document.getElementById(`${field.name}-error`);
    if (errorElement) {
      errorElement.textContent = message;
    }
  }

  // Clear field error
  function clearFieldError(field: HTMLInputElement | HTMLSelectElement): void {
    field.classList.remove('error');
    const errorElement = document.getElementById(`${field.name}-error`);
    if (errorElement) {
      errorElement.textContent = '';
    }
  }

  // Clear all errors
  function clearAllErrors(): void {
    if (!form) return;
    
    const fields = form.querySelectorAll('input, select') as NodeListOf<HTMLInputElement | HTMLSelectElement>;
    fields.forEach(field => clearFieldError(field));
  }

  // Get form data with proper type handling
  function getFormData(): { ramSpec: Partial<RAMSpecification>; contact: Partial<SellerContact> } | null {
    if (!form) return null;
    
    const formData = new FormData(form);
    
    // Helper function to safely get string values from FormData
    const getString = (key: string): string => {
      const value = formData.get(key);
      return typeof value === 'string' ? value : '';
    };
    
    // Helper function to safely parse integers
    const getInt = (key: string): number => {
      const value = getString(key);
      const parsed = parseInt(value, 10);
      return isNaN(parsed) ? 0 : parsed;
    };
    
    const ramSpec: Partial<RAMSpecification> = {
      type: getString('type') as RAMSpecification['type'] || undefined,
      capacity: getInt('capacity') || undefined,
      speed: getInt('speed') || undefined,
      brand: getString('brand') || undefined,
      condition: getString('condition') as RAMSpecification['condition'] || undefined,
      quantity: getInt('quantity') || undefined
    };

    const contact: Partial<SellerContact> = {
      name: getString('name') || undefined,
      email: getString('email') || undefined,
      phone: getString('phone') || undefined,
      preferredContact: getString('preferredContact') as SellerContact['preferredContact'] || undefined,
      location: getString('location') || undefined
    };

    return { ramSpec, contact };
  }

  // Validate entire form
  function validateForm(): boolean {
    const formData = getFormData();
    if (!formData) return false;
    
    const { ramSpec, contact } = formData;
    
    const ramValidation = validateRAMSpecification(ramSpec);
    const contactValidation = validateSellerContact(contact);
    
    // Show RAM specification errors
    ramValidation.errors.forEach((error: ValidationError) => {
      if (!form) return;
      const field = form.querySelector(`[name="${error.field}"]`) as HTMLInputElement | HTMLSelectElement | null;
      if (field) {
        showFieldError(field, error.message);
      }
    });
    
    // Show contact errors
    contactValidation.errors.forEach((error: ValidationError) => {
      if (!form) return;
      const field = form.querySelector(`[name="${error.field}"]`) as HTMLInputElement | HTMLSelectElement | null;
      if (field) {
        showFieldError(field, error.message);
      }
    });
    
    return ramValidation.isValid && contactValidation.isValid;
  }

  // Display quote results
  function displayQuote(quote: QuoteResponse): void {
    const valueElement = document.getElementById('quote-value');
    const rangeElement = document.getElementById('quote-range');
    const timelineElement = document.getElementById('quote-timeline');
    const factorsElement = document.getElementById('quote-factors');
    const stepsElement = document.getElementById('quote-next-steps');

    if (valueElement) valueElement.textContent = `$${quote.estimatedValue.toFixed(2)}`;
    if (rangeElement) rangeElement.textContent = `$${quote.priceRange.min.toFixed(2)} - $${quote.priceRange.max.toFixed(2)}`;
    if (timelineElement) timelineElement.textContent = quote.timeline;

    // Display factors
    if (factorsElement) {
      factorsElement.innerHTML = '';
      quote.factors.forEach((factor: string) => {
        const li = document.createElement('li');
        li.textContent = factor;
        factorsElement.appendChild(li);
      });
    }

    // Display next steps
    if (stepsElement) {
      stepsElement.innerHTML = '';
      quote.nextSteps.forEach((step: string) => {
        const li = document.createElement('li');
        li.textContent = step;
        stepsElement.appendChild(li);
      });
    }

    // Show results
    if (quoteResults) {
      quoteResults.style.display = 'block';
      
      // Add a fade-in animation
      quoteResults.style.opacity = '0';
      quoteResults.style.transform = 'translateY(20px)';
      
      // Trigger animation
      setTimeout(() => {
        quoteResults.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        quoteResults.style.opacity = '1';
        quoteResults.style.transform = 'translateY(0)';
      }, 100);
      
      quoteResults.scrollIntoView({ behavior: 'smooth' });
    }

    // Show success feedback message
    showQuoteGenerationSuccess();
  }

  // Show success feedback for quote generation
  function showQuoteGenerationSuccess(): void {
    // Create a temporary success message
    const successMessage = document.createElement('div');
    successMessage.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: #38a169;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 999;
        font-weight: 500;
      ">
        ‚úì Quote generated successfully!
      </div>
    `;
    
    document.body.appendChild(successMessage);
    
    // Remove the message after 3 seconds
    setTimeout(() => {
      if (successMessage.parentNode) {
        successMessage.parentNode.removeChild(successMessage);
      }
    }, 3000);
  }

  // Form submission handler
  async function handleFormSubmission(event: Event): Promise<void> {
    event.preventDefault();
    
    // Clear previous errors
    clearAllErrors();
    
    // Validate form
    if (!validateForm()) {
      return;
    }
    
    // Show loading state
    if (loadingState) loadingState.style.display = 'block';
    if (quoteResults) quoteResults.style.display = 'none';
    
    try {
      // Get form data
      const formData = getFormData();
      if (!formData) {
        throw new Error('Unable to get form data');
      }
      
      const { ramSpec } = formData;
      
      // Validate that we have a complete RAM specification
      if (!ramSpec.type || !ramSpec.capacity || !ramSpec.speed || !ramSpec.brand || !ramSpec.condition || !ramSpec.quantity) {
        throw new Error('Incomplete RAM specification');
      }
      
      // Simulate processing delay
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Generate quote with properly typed specification
      const completeRamSpec: RAMSpecification = {
        type: ramSpec.type,
        capacity: ramSpec.capacity,
        speed: ramSpec.speed,
        brand: ramSpec.brand,
        condition: ramSpec.condition,
        quantity: ramSpec.quantity
      };
      
      const quote = generateQuote(completeRamSpec);
      currentQuote = quote;
      
      // Hide loading state
      if (loadingState) loadingState.style.display = 'none';
      
      // Display quote
      displayQuote(quote);
      
    } catch (error) {
      console.error('Error generating quote:', error);
      if (loadingState) loadingState.style.display = 'none';
      alert('Sorry, there was an error generating your quote. Please try again.');
    }
  }

  // Clear form handler
  function handleClearForm(): void {
    if (!form) return;
    
    form.reset();
    clearAllErrors();
    if (quoteResults) quoteResults.style.display = 'none';
    currentQuote = null;
  }

  // New quote handler
  function handleNewQuote(): void {
    if (quoteResults) quoteResults.style.display = 'none';
    currentQuote = null;
    if (form) form.scrollIntoView({ behavior: 'smooth' });
  }

  // Accept quote handler
  async function handleAcceptQuote(): Promise<void> {
    if (!currentQuote) return;
    
    const formData = getFormData();
    if (!formData) return;
    
    const { ramSpec, contact } = formData;
    
    // Validate we have complete data
    if (!ramSpec.type || !ramSpec.capacity || !ramSpec.speed || !ramSpec.brand || 
        !ramSpec.condition || !ramSpec.quantity) {
      alert('Missing RAM specification data. Please refresh and try again.');
      return;
    }
    
    if (!contact.name || !contact.email || !contact.phone || 
        !contact.preferredContact || !contact.location) {
      alert('Missing contact information. Please refresh and try again.');
      return;
    }
    
    // Show loading state
    if (acceptQuoteButton) {
      acceptQuoteButton.disabled = true;
      acceptQuoteButton.textContent = 'Submitting...';
    }
    
    try {
      // Submit the quote request
      const completeRamSpec: RAMSpecification = {
        type: ramSpec.type,
        capacity: ramSpec.capacity,
        speed: ramSpec.speed,
        brand: ramSpec.brand,
        condition: ramSpec.condition,
        quantity: ramSpec.quantity
      };
      
      const completeContact: SellerContact = {
        name: contact.name,
        email: contact.email,
        phone: contact.phone,
        preferredContact: contact.preferredContact,
        location: contact.location
      };
      
      const result = await submitQuoteRequest(completeRamSpec, completeContact, currentQuote);
      
      if (result.success) {
        // Create personalized message
        let message = 'Thank you for accepting our quote! ';
        
        switch (completeContact.preferredContact) {
          case 'email':
            message += `We will contact you via email at ${completeContact.email} within the timeframe specified in your quote.`;
            break;
          case 'phone':
            message += `We will contact you via phone at ${completeContact.phone} within the timeframe specified in your quote.`;
            break;
          case 'either':
            message += `We will contact you via email (${completeContact.email}) or phone (${completeContact.phone}) within the timeframe specified in your quote.`;
            break;
        }
        
        // Show success confirmation
        showQuoteAcceptanceConfirmation(message, currentQuote.timeline, result.submissionId);
      } else {
        // Show error message
        alert(result.message || 'Failed to submit quote request. Please try again.');
      }
    } catch (error) {
      console.error('Error submitting quote:', error);
      alert('An error occurred while submitting your quote. Please try again or contact us directly.');
    } finally {
      // Reset button state
      if (acceptQuoteButton) {
        acceptQuoteButton.disabled = false;
        acceptQuoteButton.textContent = 'Accept This Quote';
      }
    }
  }

  // Show enhanced quote acceptance confirmation
  function showQuoteAcceptanceConfirmation(message: string, timeline: string, submissionId?: string): void {
    // Create a more prominent confirmation dialog
    const confirmationHtml = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      " id="quote-confirmation-overlay">
        <div style="
          background: white;
          padding: 2rem;
          border-radius: 8px;
          max-width: 500px;
          margin: 1rem;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        ">
          <h3 style="color: #38a169; margin-bottom: 1rem; text-align: center;">
            ‚úì Quote Accepted Successfully!
          </h3>
          <p style="margin-bottom: 1rem; line-height: 1.5;">
            ${message}
          </p>
          ${submissionId ? `
          <div style="
            background: #edf2f7;
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            text-align: center;
          ">
            <strong>Reference ID:</strong> ${submissionId}
          </div>
          ` : ''}
          <div style="
            background: #f7fafc;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid #38a169;
          ">
            <strong>Expected Response Time:</strong> ${timeline}
          </div>
          <div style="text-align: center;">
            <button onclick="closeQuoteConfirmation()" style="
              background: #3182ce;
              color: white;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 4px;
              cursor: pointer;
              font-weight: 500;
            ">
              Close
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Add the confirmation to the page
    document.body.insertAdjacentHTML('beforeend', confirmationHtml);
    
    // Add close function to global scope temporarily
    (window as any).closeQuoteConfirmation = () => {
      const overlay = document.getElementById('quote-confirmation-overlay');
      if (overlay) {
        overlay.remove();
      }
      delete (window as any).closeQuoteConfirmation;
    };
  }

  // Initialize form
  function initializeForm(): void {
    setupRealTimeValidation();
    
    // Event listeners with null safety
    if (form) form.addEventListener('submit', handleFormSubmission);
    if (clearButton) clearButton.addEventListener('click', handleClearForm);
    if (newQuoteButton) newQuoteButton.addEventListener('click', handleNewQuote);
    if (acceptQuoteButton) acceptQuoteButton.addEventListener('click', () => {
      handleAcceptQuote().catch(error => {
        console.error('Error in accept quote handler:', error);
      });
    });
  }

  // Initialize when DOM is loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeForm);
  } else {
    initializeForm();
  }
</script>